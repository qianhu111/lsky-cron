name: Check & Restore Crontabs for Multiple Accounts

on:
  schedule:
    - cron: "*/10 * * * *"  # 每10分钟执行
  workflow_dispatch:

jobs:
  cron-monitor:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install jq & sshpass
      run: |
        sudo apt-get update
        sudo apt-get install -y jq sshpass

    - name: Load and loop through servers
      run: |
        targets=$(cat targets.json)
        count=$(echo "$targets" | jq length)

        for i in $(seq 0 $((count - 1))); do
          name=$(echo "$targets" | jq -r ".[$i].name")
          ip=$(echo "$targets" | jq -r ".[$i].ip")
          port=$(echo "$targets" | jq -r ".[$i].port")
          user=$(echo "$targets" | jq -r ".[$i].user")
          pass=$(echo "$targets" | jq -r ".[$i].password")
          path=$(echo "$targets" | jq -r ".[$i].path")

          echo "Processing $name ($user@$ip:$port)"

          sshpass -p "$pass" scp -P "$port" -o StrictHostKeyChecking=no scripts/check_cron.sh "$user@$ip:/tmp/check_cron.sh"
          sshpass -p "$pass" ssh -p "$port" -o StrictHostKeyChecking=no "$user@$ip" "bash /tmp/check_cron.sh '$path'"

          echo "✅ $name done."
        done
