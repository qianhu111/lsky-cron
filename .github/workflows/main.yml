name: Check & Restore Crontabs for Multiple Accounts

on:
  schedule:
    - cron: "*/10 * * * *"  # æ¯ 10 åˆ†é’Ÿæ‰§è¡Œ
  workflow_dispatch:

jobs:
  cron-monitor:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout ä»“åº“ä»£ç 
        uses: actions/checkout@v3

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y jq sshpass

      - name: ğŸ“¦ æ‰§è¡Œä¿æ´»è„šæœ¬
        env:
          TARGETS_JSON: ${{ secrets.TARGETS_JSON }}
        run: |
          echo "âœ… æ­£åœ¨éªŒè¯ JSON æ ¼å¼..."
          echo "$TARGETS_JSON" > targets.json

          if ! jq empty targets.json; then
            echo "âŒ æ— æ³•è§£æ TARGETS_JSON"
            cat targets.json
            exit 1
          fi

          count=$(jq length targets.json)
          echo "ğŸ“¦ å…±è¯»å–åˆ° $count ä¸ªç›®æ ‡æœåŠ¡å™¨"

          for i in $(seq 0 $((count - 1))); do
            name=$(jq -r ".[$i].name" targets.json)
            ip=$(jq -r ".[$i].ip" targets.json)
            port=$(jq -r ".[$i].port" targets.json)
            user=$(jq -r ".[$i].user" targets.json)
            pass=$(jq -r ".[$i].password" targets.json)
            path=$(jq -r ".[$i].path" targets.json)

            echo "ğŸ”§ æ­£åœ¨å¤„ç† $name ($user@$ip:$port)"

            # ä¸Šä¼ è„šæœ¬åˆ° ~/ ç›®å½•
            sshpass -p "$pass" scp -P "$port" -o StrictHostKeyChecking=no scripts/check_cron.sh "$user@$ip:~/check_cron.sh"
            if [ $? -ne 0 ]; then
              echo "âŒ ä¸Šä¼ è„šæœ¬å¤±è´¥ï¼š$name"
              continue
            fi

            # æ‰§è¡Œè¿œç¨‹è„šæœ¬
            sshpass -p "$pass" ssh -p "$port" -o StrictHostKeyChecking=no "$user@$ip" "bash ~/check_cron.sh '$path'"
            if [ $? -ne 0 ]; then
              echo "âŒ æ‰§è¡Œè„šæœ¬å¤±è´¥ï¼š$name"
              continue
            fi

            echo "âœ… $name å®Œæˆ"
          done
